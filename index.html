<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="element-plus.css" />
</head>
<body>
    <div id="tpl" style="display: none"></div>
    <div id="app">
        <router-view></router-view>
    </div>
    <template id="home-tpl">
       <div style="height: 90vh; overflow-y: auto;">
           <div v-for="(img, index) in arr" :key="img.id" :col-id="img.id">
               <div>
                   <el-link type="primary" @click="goToLink(img)"><span v-html="img.hrefDispay"></span></el-link>
               </div>
               <template v-if="img.fileExt">
                   <el-image style="max-width: 100%; display: block; min-height: 200px;"
                             :src="getImg(img.href)"  :preview-src-list="bigImgList" lazy ></el-image>
                   <video style="max-width: 100%;" v-if="img.fileExt === 'mp4'" :src="getImg(img.href)" controls></video>
               </template>
           </div>
       </div>
    </template>
    <script src="/jquery.js"></script>
<!--    <script src="https://cdn.bootcdn.net/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>-->
    <!-- Import Vue 3 -->
    <script src="/Vue.js"></script>
    <script src="/vue-router.js"></script>
    <!-- Import component library -->
    <script src="/element-plus.js"></script>
    <script type="module">
        const SEVER_ORIGIN =  location.protocol + '//' + location.hostname + ':7100';
        console.log(SEVER_ORIGIN)

        function uuidv4() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function resolveHref(v, baseHref) {
            v.href = v.href.replace(baseHref, '')
            v.href = v.href.slice(0, v.href.length - 1)
            v.hrefDispay =  decodeURIComponent(v.href)
        }

        function fetchDirectoryURL(url = '', baseHref = '') {
         return new Promise(resolve => {
             fetch(url).then((res) => {
                 return res.text()
             }).then(data => {
                 document.getElementById('tpl').innerHTML = data
                 let arr = []
                 $('#tpl tr').each(function (index, item) {
                     // console.log(index, item)
                     let id =  uuidv4()
                     let href = $(item).find('.display-name > a').attr('href')
                     let hrefArr = href.split('/')
                     let fileName = hrefArr[hrefArr.length - 1]
                     let fileNameArr = fileName.split('.')
                     let fileNameNotExt = fileNameArr[0]
                     let fileExt = fileNameArr[1]
                     let ret = {
                         href,
                         hrefDispay: decodeURIComponent(href),
                         fileNameNotExt,
                         fileExt,
                         id,
                     }
                     arr.push(ret)
                 })
                 // console.log(baseHref,  arr[0].href)
                 // arr[0].href = arr[0].href.replace(baseHref, '')
                 // arr[0].href = arr[0].href.slice(0, arr[0].href.length - 1)
                 // arr[0].hrefDispay =  decodeURIComponent(arr[0].href)
                 resolveHref(arr[0], baseHref)
                 arr = arr.sort(function(a,b){
                     return a.fileNameNotExt-b.fileNameNotExt;
                 })
                 resolve(arr)
             })
         })
       }


        globalThis.resolvePath = function () {
            function resolve(pathA, pathB) {
                // 先做split，得到的结果如下几种
                //  ‘a’     => ['a']
                //  'a/b'   => ['a', 'b']
                //  '/a/b'  => ['', 'a', 'b']
                //  '/a/b/' => ['', 'a', 'b', '']
                pathB = pathB.split('/');
                if (pathB[0] === '') {
                    // 如果pathB是想对于根目录
                    // 则不在考虑pathA，直接返回pathB
                    return pathB.join('/');
                }
                pathA = pathA.split('/');
                var aLastIndex = pathA.length - 1;
                if (pathA[aLastIndex] !== '') {
                    // 文件名出栈，只保留路径
                    pathA[aLastIndex] = '';
                }

                var part;
                var i = 0;
                while (typeof(part = pathB[i]) === 'string') {
                    switch (part) {
                        case '..':
                            // 进入父级目录
                            pathA.pop();
                            pathA.pop();
                            pathA.push('');
                            break;
                        case '.':
                            // 当前目录
                            break;
                        default:
                            // 进入子目录
                            pathA.pop();
                            pathA.push(part);
                            pathA.push('');
                            break;
                    }
                    i++;
                }
                return pathA.join('/');
            }

            var paths = arguments;
            var i = 0;
            var path;
            var r = location.pathname;
            var multiSlashReg = /\/\/+/g;
            while (typeof(path = paths[i]) === 'string') {
                // '//' ==> '/'
                path = path.replace(multiSlashReg, '/');
                r = resolve(r, path);
                i++;
            }

            return r;
        };



            const Home = Vue.defineComponent({
                template: '#home-tpl',
                mounted() {
                    let { href = '' } = this.$router.currentRoute.value.query
                    this.setData({href})
                    this.inited =  true
                    // console.log('mounted')
                },
                beforeRouteUpdate (to, from) {
                    if (this.inited) {
                        let { href = '' } = to.query
                        this.setData({href})
                    }
                },
                data() {
                    return {
                        inited: false,
                        arr: [],
                    };
                },
                computed: {
                    bigImgList() {
                        return this.arr.map(v => {
                            return this.getImg(v.href)
                        })
                    }
                },
                methods: {
                    getImg(v) {
                        return SEVER_ORIGIN + v
                    },
                    async setData(link) {

                        let data = await fetchDirectoryURL(SEVER_ORIGIN + link.href, link.href)
                        // console.log(data)
                        this.arr = data
                    },
                    goToLink(img) {
                        let { href = '' } = this.$router.currentRoute.value.query
                        // console.log(img.href)
                        this.$router.push({
                            path: '/',
                            query: {
                                href: resolvePath(href, img.href)
                            }
                        })
                    }
                }
            });
            const routes = [
                {
                    path: '/',
                    component: Home
                },
            ]

            const router = VueRouter.createRouter({
                // 4. 内部提供了 history 模式的实现。为了简单起见，我们在这里使用 hash 模式。
                history: VueRouter.createWebHashHistory(),
                routes, // `routes: routes` 的缩写
            })

            const App = {}
            const app = Vue.createApp(App);
            app.use(router)

            app.config.devtools = true

            app.use(ElementPlus);
            app.mount("#app");

    </script>
</body>
</html>
